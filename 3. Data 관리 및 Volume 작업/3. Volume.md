# Volume 이란?

<img src="images/03/Volume concept.JPG">

볼륨은 간단히 말해 컨테이너를 실행시킨 호스트 시스템의 폴더라고 할 수 있다. 호스트 시스템의 폴더와 컨테이너 내부의 폴더 위치를 동기화 시켜서 어느 한쪽에서 파일을 추가하거나 삭제, 변경하면 양쪽에 다 적용된다. 

## 볼륨을 써야하는 경우

컨테이너 디렉토리에 생성된 파일들은 컨테이너가 존재하는 한 사라지지 않지만, 컨테이너가 삭제되면 그 파일들도 함께 삭제된다. 컨테이너가 삭제되어도 파일은 남아있어야 하는 경우에 볼륨을 사용하면 된다.

<br/>

## VOLUE 사용

`2. 작업을 위한 node 앱`을 기반으로 VOLUME 작업

```
VOLUME [ "directory path" ]
```

Dockerfile 파일에 위의 명령어를 입력해서, 볼륨으로 지정할 디렉토리를 명시하는 명령어를 추가한다.

```Dockerfile
...

EXPOSE 80

# 볼륨으로 지정할 디렉토리를 명시한다.
VOLUME [ "/app/feedback" ]

CMD ["node", "server.js"]
```

그리고 image를 빌드하고 실행시켜서 파일을 저장해보면 오류가 나는데, docker logs로 확인해보면 아래와 같다.

<img src="images/03/fail logs.png">

server.js 코드를 살펴보면 임시 폴더에 저장한 파일을 feedback폴더로 옮기는 rename명령어가 있다. 에러 로그에 "cross-device link not permitted" 라고 출력되는데, VOLUME이 적용되면서 컨테이너 내부에서의 동작이 아닌 컨테이너와 호스트시스템간에 연동으로 나타나는 문제이다. 즉, 단순히 파일을 옮기는 rename의 node 명령어를 수정해야한다. 따라서 소스코드를 아래와 같이 변경해야 한다.

변경 전 server.js
```javascript
await fs.rename(tempFilePath, finalFilePath);
```

변경 후 server.js
```javascript
await fs.copyFile(tempFilePath, finalFilePath);
await fs.unlink(tempFilePath);
```

단순히 파일을 옮기는 rename 명령이 아니라 파일을 복사(copyFile)하고 기존 파일은 삭제(unlink)하는 명령어로 변경하였다. 그리고 다시 이미지를 빌드하고 실행시켜서 파일을 생성한다.

<img src="images/03/feedback input.png" width="60%"><br/><br/>
<img src="images/03/hello txt check.png" width="60%"><br/>

그리고 컨테이너를 중지시켰다가 다시 실행해보면 예상과는 다르게 hello.txt파일이 남아있지 않다.

<img src="images/03/restart hello txt check.png" width="60%">


